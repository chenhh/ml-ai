# 共軛分佈(conjugate distribution)

## 簡介

在貝氏定理中，在特殊情況下，存在一個分析解決方案，可不必計算貝氏定理中中分母所要求的積分。

$$
\displaystyle \mathrm{P}(\theta|X)= \frac{\mathrm{P}(X|\theta) \mathrm{P}(\theta)} {\int_0^1 \mathrm{P}(X|\theta_p)\mathrm{P}(\theta_p)d\theta_p}
$$

使用時機：所需估計的參數來自特定的分佈，如Binomial, Poisson, Normal, Multinomial分佈時， 使用這些分佈的似然函數(likelihood)且使用對應的先驗和後驗分佈，可得參數估計值的機率分佈， 且可計算參數估計值的信賴區間，而不只是點估計式。

| 先驗分佈(prior) | 資料分佈(data)  | 後驗分佈(posterior) |
| ----------- | ----------- | --------------- |
| Beta        | Binomial    | Beta            |
| Gamma       | Poisson     | Gamma           |
| Normal      | Normal      | Normal          |
| Dicichlet   | Multinomial | Dirichlet       |

## Beta-binomial共軛範例：進入白宮的問題

假設一個平民在沒有預約的情形下，可以進入白宮拜訪總統的機率為$$p$$，總共拜訪$$n$$次， 則見到總統$$x$$次的機率分佈為$$\displaystyle \mathrm{P}(x; n, p) = \binom{n}{x}p^x(1-p)^{n-x}, ~ x=0,1,\dots, n$$。

問題的目標是要估計參數$$p$$，可使用貝氏方法如下:

1. 給定參數$$p$$的先驗分佈。(使用Beta分佈$$beta(\alpha, \beta)$$描述$$p \in (0,1)$$的假設)
2. 收集資訊，計算成功與失敗的次數。
3. 決定已觀察到資料的似然性。
4. 使用貝氏定理計算$$p$$的後驗分佈。

Beta分佈的pdf形式如下:

$$
\displaystyle f(x; \alpha, \beta) = \frac{1}{B(\alpha, \beta)} x^{\alpha -1} (1-x)^{\beta-1}, ~ 0 < x < 1
$$

其中$$B$$為beta函數，是用於正規化機率值。

Beta分佈的平均值為$$\mu=\frac{\alpha}{\alpha + \beta}$$， 變異數為$$\sigma^2 = \frac{\alpha \beta}{(\alpha + beta)^2 (\alpha + \beta + 1)}$$

假設Beta先驗分佈的參數為$$\alpha_0, \beta_0$$，經過$$n$$次試驗後，成功$$x$$次時， 可得後驗分佈也是Betap分佈，不必計算積分，且可得參數更新公式如下：

* $$\alpha_{\text{posterior}} = \alpha_0 + x$$
* $$\beta_{\text{posterior}} = \beta_0 + n - x$$

### 貝氏更新

給定beta分佈的初始超參數(hyperparameters)$$\alpha_0=0.5$$, $$\beta_0=0.5$$。

如果進行一次試驗(n=1)，且結果為失敗$$x=0$$，則可得更新後的超參數為：

* $$\alpha_1 = \alpha_0 + x = 0.5 + 0 = 0.5$$
* $$\beta_1 = \beta_0 + n - x = 0.5 +1 - 0 = 1.5$$

若再進行一次試驗，且結果還是失敗，可得更新後的超參數為：

* $$\alpha_2 = \alpha_1 + x = 0.5 + 0 = 0.5$$
* $$\beta_2 = \beta_1 + n - x = 1.5 +1 - 0 = 2.5$$

此時由Beta分佈的均值$$\mu=\frac{\alpha}{\alpha+\beta}=\frac{0.5}{0.5+2.5}=0.1667$$ 與變異數$$\sigma^2 = \frac{\alpha \beta}{(\alpha + beta)^2 (\alpha + \beta + 1)} =0.0617$$可用beta分佈得到二項式分佈參數$$p$$的信賴區間。

如果在給定先驗後，直接進行兩次試驗，且兩次均為失敗時，也可得到相同的結果：

* $$\alpha_2 = \alpha_0 + x = 0.5 + 0 = 0.5$$
* $$\beta_2 = \beta_0 + n - x = 0.5 +2 - 0 = 2.5$$

在這裡，你可以看到貝氏推理的主要好處：隨著我們收集更多的資料，我們更新我們的信念。 我們從先驗開始，收集資料，然後使用貝氏定理來產生後驗。這些後驗值然後成為下一輪資料收集的先驗值。

## Gamma-poisson共軛範例: 鯊魚攻擊問題

Poisson分佈$$P(\lambda)$$，其中參數$$\lambda$$為單位時間內，事件發生的平均次數。 其pdf如下：

$$
\displaystyle \mathrm{P}(X=x; \lambda) = \frac{\lambda^x e^{-\lambda}}{x!}, ~ x=0,1,2,\dots
$$

| 年   | 攻擊次數 |
| --- | ---- |
| 1   | 1    |
| 2   | 0    |
| 3   | 2    |
| 4   | 1    |
| 5   | 1    |
| 6   | 3    |
| 7   | 2    |
| 8   | 3    |
| 9   | 4    |
| 10  | 4    |
| 平均值 | 2.1  |

由歷史資料可得下一次發生3次攻擊的機率為$$\mathrm{P}(3;2.1) = \frac{2.1^{3} e^{2.1}}{3!}=0.189$$

如果在今年觀測到5次鯊魚攻擊，則在不同$$\lambda$$相異假設下，觀察到5次鯊魚襲擊的可能性是多少？鯊魚襲擊的可能性是多少？ 當似然函數為Poisson分佈時，先驗/後驗分佈是Gamma分佈$$\Gamma(k, \theta)$$時為共軛分佈。

Gamma分佈的兩個參數$$k, \theta$$有三種常見的使用方式：

* $$k$$為形狀(shape)參數，$$\theta$$為規模(scale)參數。
* \[貝氏機率使用] 形狀參數$$\alpha = k$$，速度(rate)參數$$\beta = \frac{1}{\theta}$$。
* 形狀參數$$k$$，平均參數$$\mu = \frac{k}{\beta}$$。

Gamma分佈的pdf形式如下：

$$
\displaystyle f(x;\alpha, \beta)=\frac{\beta^\alpha x^{\alpha-1} e^{-\beta x}}{\Gamma(\alpha)} ~ 0 < x < \infty, ~ \alpha > 0, ~ \beta > 0
$$

其中$$G(\cdot)$$為Gamma函數, 當$$n$$為自然數時，$$\Gamma(n)=(n-1)!$$。

平均值$$\mu = k\theta$$或$$\frac{\alpha}{\beta}$$，變異數為$$k \theta^2$$或$$\frac{\alpha}{\beta^2}$$。

* 可由資料的平均值和變異數反推先驗分佈中的$$\alpha_0=2.1,~ \beta_0=1$$。
* 現在觀察到5隻鯊魚，由$$P(\lambda=2.1)$$計算得到似然率$$\mathrm{P}(X=5; \lambda=2.1)=0.04167704$$
* 更新Gamma分佈的後驗參數：
  * $$\alpha_{\text{posterior}} = \alpha_0 + \sum_{i=1}^n x_i$$,
  *
  * $$x$$為觀察到的發生次數，$$n$$為觀察的次數(年)
  * 可得$$\alpha_1 = 2.1 + 5 = 7.1$$, $$\beta_1 = 1 + 1= 2$$

## Normal-normal共軛

常態分佈的pdf:

$$
\displaystyle f(x; \mu, \sigma^2) = \frac{1}{\sqrt{2\pi}\sigma} e^{-\frac{(x-\mu)^2}{2 \sigma^2}}
$$

由資料計算先驗分佈的$$\mu_0=9.45,~\sigma_0^2=1.98^2$$。

假設觀測值$$x=10.2$$，由pdf得機率$$f(10.2; 9.45, 1.98^2)=0.1875$$

現在的目標是估計常態分佈的平均值與變異數。假設現在觀察到10組平均值與變異數的組合，且這10組的先驗為均勻分佈。給定新的觀測值$$(\mu, \sigma)=(9.45, 1.98)$$後，可用pdf算出似然性與後驗分佈如下表：

| Hypothesis | $$\mu$$ | $$\sigma$$ | x    | Prior (Pr) | Likelihood | L \* Pr | Denominator | Posterior |
| ---------- | ------- | ---------- | ---- | ---------- | ---------- | ------- | ----------- | --------- |
| 1          | 9.97    | 1.75       | 10.2 | 0.1        | 0.2260     | 0.0226  | 0.1842      | 0.1227    |
| 2          | 10.26   | 1.83       | 10.2 | 0.1        | 0.2179     | 0.0218  | 0.1842      | 0.1183    |
| 3          | 11.94   | 2.05       | 10.2 | 0.1        | 0.1357     | 0.0136  | 0.1842      | 0.0738    |
| 4          | 10.85   | 1.78       | 10.2 | 0.1        | 0.2097     | 0.0210  | 0.1842      | 0.1140    |
| 5          | 9.58    | 1.83       | 10.2 | 0.1        | 0.2058     | 0.0206  | 0.1842      | 0.1118    |
| 6          | 9.45    | 1.98       | 10.2 | 0.1        | 0.1875     | 0.0188  | 0.1842      | 0.1021    |
| 7          | 11.71   | 2.21       | 10.2 | 0.1        | 0.1429     | 0.0143  | 0.1842      | 0.0776    |
| 8          | 10.51   | 2.04       | 10.2 | 0.1        | 0.1933     | 0.0193  | 0.1842      | 0.1048    |
| 9          | 12.3    | 1.79       | 10.2 | 0.1        | 0.1120     | 0.0112  | 0.1842      | 0.0608    |
| 10         | 10.36   | 1.89       | 10.2 | 0.1        | 0.2103     | 0.0210  | 0.1842      | 0.1140    |

第2、3欄是相異常態分佈假設的$$(\mu,\sigma)$$之值，第4欄是觀察值，第5欄是每個假設的先驗機率，第6欄是觀察值在該假設常態分佈下的似然率$$\mathrm{P}(x|\mu, \sigma)$$，第7欄是先驗乘以似然率之計算值，第8欄為第7欄的總和，第9欄後驗機率為第7欄/第8欄之值。

上例為參數為離散變數時的方法，但常態分佈的參數是連續值，有無限組組合。

使用normal-normal共軛時，必須已知平均值$$\mu$$或變異數$$\sigma^2$$之值(或者使用精度$$\tau=\frac{1}{\sigma^2}$$)。

更新公式, $$n$$為觀測得到的資料筆數，已知$$\tau$$：

* $$\mu_{\text{posterior}} = \frac{\tau_0 \mu_0 + \tau \sum_{i=1}^n x_i}{ \tau_0 + n \times \tau}$$
* $$\tau_{\text{posterior}} = \tau_0 + n \times \tau$$



